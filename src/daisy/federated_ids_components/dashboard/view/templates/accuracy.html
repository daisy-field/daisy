{% extends "./base.html" %}
{% block body_theme %}
{% if dark_theme %}
"sb-nav-fixed bg-dark"
{% else %}
"sb-nav-fixed"
{% endif %}
{% endblock %}

{% block footer_theme %}
{% if dark_theme %}
"py-4 bg-dark mt-auto"
{% else %}
"py-4 mt-auto"
{% endif %}
{% endblock %}

{% block navbar_theme %}
{% if dark_theme %}
"sb-sidenav accordion sb-sidenav-dark"
{% else %}
"sb-sidenav accordion sb-sidenav-light"
{% endif %}
{% endblock %}

{% block main %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://www.gstatic.com/charts/loader.js" type="text/javascript"></script>

<script type="text/javascript">
    google.charts.load('current', {'packages': ['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {

        {%
            if not dark_theme %
        }
        var options = {
            curveType: 'function',
            backgroundColor: {fill: 'transparent'},
            legend: 'bottom',

        };
        {% else %
        }
        var options = {
            backgroundColor: 'transparent', // Set background color to transparent
            curveType: 'function',


            hAxis: {
                textStyle: {
                    color: '#FFFFFF' // Set text color for horizontal axis labels
                },
                gridlines: {
                    color: '#444444' // Set color of gridlines for horizontal axis
                }
            },
            vAxis: {
                textStyle: {
                    color: '#FFFFFF' // Set text color for vertical axis labels
                },
                gridlines: {
                    color: 'transparent' // Set color of gridlines for vertical axis
                }
            },
            legend: {
                position: 'top',
                textStyle: {
                    color: '#FFFFFF' // Set text color for legend
                }
            },
            titleTextStyle: {
                color: '#FFFFFF' // Set text color for chart title
            }
        };
        {%
            endif %
        }

        var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

        function sendRequest() {
            $.ajax({
                url: "http://127.0.0.1:8000/metrics/",
                type: "GET",
                dataType: "json",
                success: (response) => {

                    var data = google.visualization.arrayToDataTable([
                        ["Time"],
                        [""]
                    ])

                    nodes = []
                    response.forEach(function (element) {
                        if (!nodes.includes(element.address)) {
                            nodes.push(element.address)
                        }
                    })
                    times = []
                    response.forEach(function (element) {
                        if (!times.includes(element.timestamp)) {
                            times.push(element.timestamp)
                        }
                    })

                    nodes.forEach(function (element) {
                        data.addColumn('number', element);

                    })

                    times.forEach(function (time) {
                        var row = [time]

                        nodes.forEach(function (node) {
                            var found = false
                            response.forEach(function (element) {
                                //console.log(element.time, element.address, time, node)
                                if (element.timestamp == time && element.address == node) {
                                    row.push(element.accuracy)
                                    found = true
                                    console.log("Found")
                                }
                            })
                            if (found === false) {

                                row.push(0)  //null

                            }

                        })
                        data.addRow(row)


                    })
                    chart.draw(data, options);


                    var currentdate = new Date();
                    var datetime = +currentdate.getDate() + "/"
                        + (currentdate.getMonth() + 1) + "/"
                        + currentdate.getFullYear() + " -- "
                        + currentdate.getHours() + ":"
                        + currentdate.getMinutes() + ":"
                        + currentdate.getSeconds();
                    $("#updated").text("Last update: " + datetime)


                },
                error: (error) => {
                    console.log(error);
                }

            })
        }

        sendRequest();
        setInterval(sendRequest, 10000);

    }


</script>
<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item active"></li>
</ol>
<div %} class={% dark_theme if
"card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
<div class="card-header">
    <i class="fas fa-chart-area me-1"></i>
    Accuracy
</div>
<div class="card-body">
    <div id="curve_chart" style="width: 100%; height: 500px"></div>

</div>
<div class="card-footer small text-muted" id="updated"></div>


{% endblock %}
