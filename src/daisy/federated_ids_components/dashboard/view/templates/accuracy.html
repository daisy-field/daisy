<!--
  ~ Copyright (C) 2024 DAI-Labor and others
  ~
  ~ This Source Code Form is subject to the terms of the Mozilla Public
  ~ License, v. 2.0. If a copy of the MPL was not distributed with this
  ~ file, You can obtain one at https://mozilla.org/MPL/2.0/.
  -->
{% extends "./base.html" %}
{% block body_theme %}
{% if dark_theme %}
"sb-nav-fixed bg-dark"
{% else %}
"sb-nav-fixed"
{% endif %}
{% endblock %}

{% block footer_theme %}
{% if dark_theme %}
"py-4 bg-dark mt-auto"
{% else %}
"py-4 mt-auto"
{% endif %}
{% endblock %}

{% block navbar_theme %}
{% if dark_theme %}
"sb-sidenav accordion sb-sidenav-dark"
{% else %}
"sb-sidenav accordion sb-sidenav-light"
{% endif %}
{% endblock %}

{% block main %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script type="text/javascript">
    google.charts.load('current', {'packages': ['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {

        {%if not dark_theme %}
        var options = {
            backgroundColor: {fill: 'transparent'},
            legend: 'top',
            vAxis:{viewWindow: {
                        min: 0,
                         max: 1
        }},
        {%if interpolation %}interpolateNulls: true,
        {%endif%}
        {%if smoothing %}curveType: 'function',
        {%endif%}

        };
        {% else %}
        var options = {
            {%if interpolation %}interpolateNulls: true,
            {%endif%}
            {%if smoothing %}curveType: 'function',
            {%endif%}
            backgroundColor: 'transparent', // Set background color to transparent

            hAxis: {
                textStyle: {
                    color: '#FFFFFF' // Set text color for horizontal axis labels
                },
                gridlines: {
                    color: 'transparent' // Set color of gridlines for horizontal axis
                },
            },
            vAxis: {
                textStyle: {
                    color: '#FFFFFF' // Set text color for vertical axis labels
                },
                gridlines: {
                    color: 'transparent' // Set color of gridlines for vertical axis
                },
                viewWindow: {
                        min: 0,
                         max: 1
                 }
            },
            legend: {
                position: 'top',
                textStyle: {
                    color: '#FFFFFF' // Set text color for legend
                }
            },
            titleTextStyle: {
                color: '#FFFFFF' // Set text color for chart title
            }
        };
        {%endif %}

        var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

        function sendRequest() {
            $.ajax({
                url: "http://127.0.0.1:8000/metrics/",
                type: "GET",
                dataType: "json",
                success: (response) => {

                    var data = google.visualization.arrayToDataTable([
                        ["Time"],
                        [new Date()]
                    ])

                    nodes = []
                    times =[]
                    response.forEach(function (element) {
                        if (!nodes.includes(element.address)) {
                            nodes.push(element.address)
                        }
                        if (!times.includes(new Date(element.timestamp))) {
                            times.push(new Date(element.timestamp))
                        }
                    })
                    console.log(nodes.length)
                    console.log(times.length)

                    nodes.forEach(function (element) {
                        data.addColumn('number', element);
                    })




                    times.forEach(function (time) {
                        var accuracyRow = [time]
                        nodes.forEach(function (node) {
                            var found = false
                            for (let i = 0; i < response.length; i++) {
                                var element = response[i];
                                if ((new Date(element.timestamp).getTime() == time.getTime()) && element.address == node) {
                                    accuracyRow.push(element.accuracy)
                                    found = true
                                    break;
                                }
                            }
                            if (found === false) {
                                accuracyRow.push(null)  //null
                            }

                        })
                        data.addRow(accuracyRow)
                    })

                    
                    chart.draw(data, options);
                    document.getElementById('exportButton').addEventListener('click', function() {
                    exportTableToCSV(data);
                      });

                    var currentdate = new Date();
                    var datetime = currentdate.getDate() + "/"
                        + (currentdate.getMonth() + 1) + "/"
                        + currentdate.getFullYear() + " -- "
                        + currentdate.getHours() + ":"
                        + currentdate.getMinutes() + ":"
                        + currentdate.getSeconds();
                    $("#updated").text("Last update: " + datetime)


                },
                error: (error) => {
                    console.log(error);
                }

            })
        }

        function exportTableToCSV(dataTable) {
            var csvData = [];
            var numRows = dataTable.getNumberOfRows();
            var numCols = dataTable.getNumberOfColumns();

            // Extract headers
            var headers = [];
            for (var col = 0; col < numCols; col++) {
                headers.push(dataTable.getColumnLabel(col));
            }
            csvData.push(headers.join(','));

            // Extract rows
            for (var row = 0; row < numRows; row++) {
                var rowData = [];
                for (var col = 0; col < numCols; col++) {
                    rowData.push(dataTable.getValue(row, col));
                }
                csvData.push(rowData.join(','));
            }

            // Create CSV file
            var csvString = csvData.join('\n');
            var blob = new Blob([csvString], {type: 'text/csv'});
            var url = window.URL.createObjectURL(blob);

            // Create a link to download the CSV
            var a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'accuracy_data.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        sendRequest();
        setInterval(sendRequest, 30000);

    }


</script>
<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item active"></li>
</ol>
                         <div class={% if dark_theme %}
        "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
        <div class="card-header">
            <i class="fas fa-chart-area me-1"></i>
            Accuracy
            <a style="  float:right;"
id="exportButton" type="button" class="btn btn-dark">Export data</a>
        </div>
        <div class="card-body">
    <div id="curve_chart" style="width: 100%; height: 500px"></div>

        </div>

        <div id="updated" class="card-footer small text-muted"></div>




{% endblock %}
