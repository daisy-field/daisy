<!--
  ~ Copyright (C) 2024 DAI-Labor and others
  ~
  ~ This Source Code Form is subject to the terms of the Mozilla Public
  ~ License, v. 2.0. If a copy of the MPL was not distributed with this
  ~ file, You can obtain one at https://mozilla.org/MPL/2.0/.
  -->
{% extends "./base.html" %}
{% block body_theme %}
{% if dark_theme %}
"sb-nav-fixed bg-dark"
{% else %}
"sb-nav-fixed"
{% endif %}
{% endblock %}

{% block footer_theme %}
{% if dark_theme %}
"py-4 bg-dark mt-auto"
{% else %}
"py-4 mt-auto"
{% endif %}
{% endblock %}

{% block navbar_theme %}
{% if dark_theme %}
"sb-sidenav accordion sb-sidenav-dark"
{% else %}
"sb-sidenav accordion sb-sidenav-light"
{% endif %}
{% endblock %}

{% block main %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.3"></script>

<script type="text/javascript">

    //TODO: fix chart coloring, fix live view
     var nodes = []
        var times = []

      window.onload = function() {



        const accuracyctx = document.getElementById('accuracy_chart').getContext('2d');
        const accuracyData = {labels: [], datasets: []};
        const accuracyChart = new Chart(accuracyctx, {type: 'line', data: accuracyData});

        const precisionctx = document.getElementById('precision_chart').getContext('2d');
        const precisionData = {labels: [], datasets: []};
        const precisionChart = new Chart(precisionctx, {type: 'line', data: precisionData});

        const f1ctx = document.getElementById('f1_chart').getContext('2d');
        const f1Data = {labels: [], datasets: []};
        const f1Chart = new Chart(f1ctx, {type: 'line', data: f1Data});

        const recallctx = document.getElementById('recall_chart').getContext('2d');
        const recallData = {labels: [], datasets: []};
        const recallChart = new Chart(recallctx, {type: 'line', data: recallData});

        var updateInterval = 30


        function initialRequest(){
            $.ajax({
                 url: "http://127.0.0.1:8000/metrics/",
                type: "GET",
                dataType: "json",
                success: (response) => {
                    function getRandomColor() {
                        const letters = '0123456789ABCDEF';
                        let color = '#';
                        for (let i = 0; i < 6; i++) {
                            color += letters[Math.floor(Math.random() * 16)];
                        }
                        return color;
                    }
                    console.log("Response")
                    response.forEach(function (element) {
                        if (!nodes.includes(element.address)) {
                            nodes.push(element.address)
                        }
                        if (!times.includes(new Date(element.timestamp))) {
                            times.push(new Date(element.timestamp))
                        }
                    })
                    console.log(nodes.length)
                    console.log(times.length)
                    timeStrings = []
                    times.forEach(function (time) {
                        timeStrings.push(time.toLocaleString())
                    })
                    accuracyData.labels=timeStrings
                    recallData.labels=timeStrings
                    precisionData.labels=timeStrings
                    f1Data.labels=timeStrings
                    accuracyData.datasets=[]
                    recallData.datasets=[]
                    precisionData.datasets=[]
                    f1Data.datasets=[]
                    nodes.forEach(function (node) {
                        var accuracyRow = []
                        var precisionRow = []
                        var f1Row = []
                        var recallRow = []
                        times.forEach(function (time) {
                            var found = false
                            for (let i = 0; i < response.length; i++) {
                                var element = response[i];
                                if ((new Date(element.timestamp).getTime() == time.getTime()) && element.address == node) {
                                    precisionRow.push(element.precision)
                                    f1Row.push(element.f1)
                                    recallRow.push(element.recall)
                                    accuracyRow.push(element.accuracy)
                                    found = true
                                    break;
                                }
                            }
                            if (found === false) {
                                precisionRow.push(null)
                                accuracyRow.push(null)  //null
                                f1Row.push(null)
                                recallRow.push(null)                            }
                        })
                        color = getRandomColor()
                        accuracyData.datasets.push({
                                  label: node,
                                  data: accuracyRow,
                                  borderColor: color, // Generate random color for each node
                                  backgroundColor: color, // Generate random color for each node
                                  fill: false,
                                  cubicInterpolationMode: 'monotone',
                                  tension: 0.4,
                                  spanGaps: true,
                                  });
                        precisionData.datasets.push({
                                  label: node,
                                  data: precisionRow,
                                  borderColor: color, // Generate random color for each node
                                  backgroundColor: color, // Generate random color for each node
                                  fill: false,
                                  cubicInterpolationMode: 'monotone',
                                  tension: 0.4,
                                  spanGaps: true,
                                  });
                        f1Data.datasets.push({
                                  label: node,
                                  data: f1Row,
                                  borderColor: color, // Generate random color for each node
                                  backgroundColor: color, // Generate random color for each node
                                  fill: false,
                                  cubicInterpolationMode: 'monotone',
                                  tension: 0.4,
                                  spanGaps: true,
                                  });
                        recallData.datasets.push({
                                  label: node,
                                  data: recallRow,
                                  borderColor: color, // Generate random color for each node
                                  backgroundColor: color, // Generate random color for each node
                                  fill: false,
                                  cubicInterpolationMode: 'monotone',
                                  tension: 0.4,
                                  spanGaps: true,
                                  });
                      accuracyChart.update();
                      precisionChart.update();
                      recallChart.update();
                      f1Chart.update();
                    })



                    var currentdate = new Date();
                    var datetime = currentdate.getDate() + "/"
                        + (currentdate.getMonth() + 1) + "/"
                        + currentdate.getFullYear() + " -- "
                        + currentdate.getHours() + ":"
                        + currentdate.getMinutes() + ":"
                        + currentdate.getSeconds();
                    $("#updated").text("Last update: " + datetime)



                },
                error: (error) => {
                    console.log(error);
                }

            })
        }
        function getAlerts() {
             $.ajax({
                 url: "http://127.0.0.1:8000/alert/",
                 type: "GET",
                 async: true,
                 dataType: "json",
                 success: (response) => {

                     var alerts = 0
                     var warnings = 0

                     for (let i = 0; i < response.length; i++) {        //type = danger, warning, info
                          if (response[i].active == true && response[i].category == "alert"){
                                    alerts = alerts+1
                               var element = document.getElementById("alert-card");
                                     element.classList.add("bg-danger");
                          }
                         if (response[i].active == true & response[i].category == "warning"){
                                 warnings = warnings+1
                                  var element = document.getElementById("warning-card");
                                     element.classList.add("bg-warning");
                         }
                     }
                     if(alerts == 0){
                            var element = document.getElementById("alert-card");
                                     element.classList.remove("bg-danger");
                     }
                      if(warnings == 0){
                            var element = document.getElementById("warning-card");
                                     element.classList.remove("bg-warning");
                     }

                    document.getElementById('alert_box').innerText   = alerts
                    document.getElementById('warning_box').innerText   = warnings
                 },
                 error: (error) => {
                     console.log(error);
                 }

             })
         }
         function getServerStates() {
             $.ajax({
                 url: "http://127.0.0.1:8000/aggregation/",
                 type: "GET",
                 async: true,
                 dataType: "json",
                 success: (response) => {
                     const givenDate = new Date(response[response.length-1].agg_time);
                     const timeDifferenceMs = new Date() - givenDate;
                     const diffMinutes = Math.floor(timeDifferenceMs / (1000 * 60));
                     if(diffMinutes< 1){
                         var element = document.getElementById("agg_box");
                         document.getElementById("agg_status").innerText = response[response.length-1].agg_status;
                         document.getElementById("agg_count").innerText = response[response.length-1].agg_count;
                         element.classList.add("bg-success");
                         element.classList.remove("bg-warning");
                     }
                     else{
                         var element = document.getElementById("agg_box");
                         document.getElementById("agg_status").innerText = "Offline";
                         document.getElementById("agg_count").innerText = "-";
                         element.classList.remove("bg-success");
                         element.classList.add("bg-warning");
                     }
                     document.getElementById("agg_time").innerText = (new Date(response[response.length-1].agg_time)).toLocaleString();
                     },
                 error: (error) => {
                     console.log(error);
                 }
             })
             $.ajax({
                 url: "http://127.0.0.1:8000/prediction/",
                 type: "GET",
                 async: true,

                 dataType: "json",
                 success: (response) => {
                     const givenDate = new Date(response[response.length-1].pred_time);
                     const timeDifferenceMs = new Date() - givenDate;
                     const diffMinutes = Math.floor(timeDifferenceMs / (1000 * 60));
                     if(diffMinutes< 1){
                         var element = document.getElementById("pred_box");
                         document.getElementById("pred_status").innerText = response[response.length-1].pred_status;
                         document.getElementById("pred_count").innerText = response[response.length-1].pred_count;
                         element.classList.add("bg-success");
                         element.classList.remove("bg-warning");
                     }
                     else{
                          var element = document.getElementById("pred_box");
                          document.getElementById("pred_status").innerText = "Offline";
                          document.getElementById("pred_count").innerText = "-";
                          element.classList.remove("bg-success");
                          element.classList.add("bg-warning");
                     }
                     document.getElementById("pred_time").innerText = (new Date(response[response.length-1].pred_time)).toLocaleString();
                     },
                 error: (error) => {
                     console.log(error);
                 }
             })
             $.ajax({
                 url: "http://127.0.0.1:8000/evaluation/",
                 type: "GET",
                 dataType: "json",
                 async: true,

                 success: (response) => {
                     const givenDate = new Date(response[response.length-1].eval_time);
                     const timeDifferenceMs = new Date() - givenDate;
                     const diffMinutes = Math.floor(timeDifferenceMs / (1000 * 60));
                     if(diffMinutes< 1){
                         var element = document.getElementById("eval_box");
                         document.getElementById("eval_status").innerText = response[response.length-1].eval_status;
                         document.getElementById("eval_count").innerText = response[response.length-1].eval_count;
                         element.classList.add("bg-success");
                         element.classList.remove("bg-warning");
                     }
                     else{
                          var element = document.getElementById("eval_box");
                          document.getElementById("eval_status").innerText = "Offline";
                          document.getElementById("eval_count").innerText = "-";
                          element.classList.remove("bg-success");
                          element.classList.add("bg-warning");
                     }
                     document.getElementById("eval_time").innerText = (new Date(response[response.length-1].eval_time)).toLocaleString();
                     },
                 error: (error) => {
                     console.log(error);
                 }
             })

         }


        initialRequest();
        setInterval(initialRequest, updateInterval*1000);
        $(window).resize(function(){
                    initialRequest()
        });
        getServerStates();
        setInterval(getServerStates, updateInterval*1000);

        getAlerts();
        setInterval(getAlerts, updateInterval* 1000);

    }


</script>


<br>
<br>
<div class={% if dark_theme %}"card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
    <div class="card-header">
        <i class="fa-solid fa-signal"></i>
        Operational Status
    </div>
    <div class="card-body">
        <div class="row">

            <div class="col-xl-3 col-md-6">
                <div id="agg_box" class="card bg-warning text-white mb-4" style="height:6cm;  display:flex">
                    <div class="card-header"><i class="fa-solid fa-server"></i> Model Aggregation</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-8 col-md-6">
                                 <div id="agg_status"></div> <br>
                                Last connection: <div id="agg_time"></div>
                            </div>
                            <div class="col-xl-4 col-md-6">
                                Nodes:
                                <p style="font-size:40px;" id="agg_count"></p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href={% url "aggregate" %} >View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div id="pred_box" class="card bg-warning text-white mb-4" style="height:6cm;  display:flex">
                    <div class="card-header"><i class="fa-solid fa-server"></i> Prediction Aggregation</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-8 col-md-6">
                                <div id="pred_status"></div><br>
                                Last connection:<div id="pred_time"></div>
                            </div>
                            <div class="col-xl-4 col-md-6">
                                Nodes:
                                <p style="font-size:40px;" id="pred_count"></p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href={% url "evaluate" %} >View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div id="eval_box" class="card bg-warning text-white mb-4" style="height:6cm;  display:flex">
                    <div class="card-header"><i class="fa-solid fa-chart-line"></i> Evaluation Aggregation</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-8 col-md-6">
                                <div id="eval_status"></div><br>
                                Last connection:<div id="eval_time"></div>
                            </div>
                            <div class="col-xl-4 col-md-6">
                                Nodes:
                                <p style="font-size:40px;" id="eval_count"></p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href={% url "evaluate" %} >View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>


            <div class="col-xl-3 col-md-6">
                <div id="warning-card" class="card bg-secondary text-white mb-4" style="height:2.7cm;  display:flex">
                    <div class="card-header"><i class="fa-solid fa-triangle-exclamation"></i> Warnings</div>
                    <div class="card-body">
                        <div id ="warning_box" style="font-size:30px; margin-top: -0.3cm"></div>
                    </div>
                    <a class="small text-white stretched-link" href={% url "alerts" %} ></a>

                </div>

                <div  id="alert-card" class="card bg-secondary text-white mb-4" style="height:2.7cm; display:flex">
                    <div class="card-header"><i class="fa-solid fa-skull-crossbones"></i> Alerts
                    </div>
                    <div class="card-body">
                        <p id ="alert_box"  style="font-size:30px; margin-top: -0.3cm"></p>
                    </div>
                                        <a class="small text-white stretched-link" href={% url "alerts" %} ></a>

                </div>
            </div>

        </div>

    </div>
    <div id="updated" class="card-footer small text-muted"></div>

</div>


<div class="row">
    <div class="col-xl-6 col-md-6">
        <div class={% if dark_theme %}
            "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %} >
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                F1-Score
            </div>
            <canvas id="f1_chart"></canvas>
            <div id="updated4" class="card-footer small text-muted">
                <a class="small text-secondary stretched-link" href={% url "f1-score" %} >View Details</a>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6">
        <div class={% if dark_theme %}
            "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                Precision
            </div>
            <canvas id="precision_chart"></canvas>
            <div id="updated1" class="card-footer small text-muted">
                <a class="small text-secondary stretched-link" href={% url "precision" %} >View Details</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-6 col-md-6">
        <div class={% if dark_theme %}
        "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                Recall
            </div>
            <canvas id="recall_chart"></canvas>
            <div id="updated2" class="card-footer small text-muted">
                <a class="small text-secondary stretched-link" href={% url "recall" %} >View Details</a>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6">
        <div class={% if dark_theme %}
        "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                Accuracy
            </div>
            <canvas id="accuracy_chart"></canvas>
            <div id="updated3" class="card-footer small text-muted">
                <a class="small text-secondary stretched-link" href={% url "accuracy" %} >View Details</a>
            </div>
        </div>
    </div>

</div>


{% endblock %}
