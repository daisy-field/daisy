<!--
  ~ Copyright (C) 2024 DAI-Labor and others
  ~
  ~ This Source Code Form is subject to the terms of the Mozilla Public
  ~ License, v. 2.0. If a copy of the MPL was not distributed with this
  ~ file, You can obtain one at https://mozilla.org/MPL/2.0/.
  -->
{% extends "./base.html" %}
{% block body_theme %}
{% if dark_theme %}
"sb-nav-fixed bg-dark"
{% else %}
"sb-nav-fixed"
{% endif %}
{% endblock %}

{% block footer_theme %}
{% if dark_theme %}
"py-4 bg-dark mt-auto"
{% else %}
"py-4 mt-auto"
{% endif %}
{% endblock %}

{% block navbar_theme %}
{% if dark_theme %}
"sb-sidenav accordion sb-sidenav-dark"
{% else %}
"sb-sidenav accordion sb-sidenav-light"
{% endif %}
{% endblock %}

{% block main %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script type="text/javascript">
    google.charts.load('current', {'packages': ['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    var updateInterval = 30
    function drawChart() {
        var accuracyData = google.visualization.arrayToDataTable([
            ['Time', 'Nodes'],
            [new Date(), 1000],
        ]);

        {%if not dark_theme %}
        var options = {
            backgroundColor: {fill: 'transparent'},
            legend: 'top',

        };
        {% else %}
        var options = {
            backgroundColor: 'transparent', // Set background color to transparent

            hAxis: {
                textStyle: {
                    color: '#FFFFFF' // Set text color for horizontal axis labels
                },
                gridlines: {
                    color: 'transparent' // Set color of gridlines for horizontal axis
                }
            },
            vAxis: {
                textStyle: {
                    color: '#FFFFFF' // Set text color for vertical axis labels
                },
                gridlines: {
                    color: 'transparent' // Set color of gridlines for vertical axis
                }
            },
            legend: {
                position: 'top',
                textStyle: {
                    color: '#FFFFFF' // Set text color for legend
                }
            },
            titleTextStyle: {
                color: '#FFFFFF' // Set text color for chart title
            }
        };
        {%endif %}

        var accuracy_chart = new google.visualization.LineChart(document.getElementById('accuracy_chart'));
        var f1_chart = new google.visualization.LineChart(document.getElementById('f1_chart'));
        var precision_chart = new google.visualization.LineChart(document.getElementById('precision_chart'));
        var recall_chart = new google.visualization.LineChart(document.getElementById('recall_chart'));


        function sendRequest() {
            $.ajax({
                url: "http://127.0.0.1:8000/metrics/",
                type: "GET",
                async: true,
                dataType: "json",
                success: (response) => {

                    accuracyData = google.visualization.arrayToDataTable([
                        ["Time"],
                        [new Date()]
                    ])
                    var f1Data = google.visualization.arrayToDataTable([
                        ["Time"],
                        [new Date()]
                    ])
                    var recallData = google.visualization.arrayToDataTable([
                        ["Time"],
                        [new Date()]
                    ])
                    var precisionData = google.visualization.arrayToDataTable([
                        ["Time"],
                        [new Date()]
                    ])

                    nodes = []
                    response.forEach(function (element) {
                        if (!nodes.includes(element.address)) {
                            nodes.push(element.address)
                        }
                    })
                    times = []
                    response.forEach(function (element) {
                        if (!times.includes(element.timestamp)) {
                            times.push(new Date(element.timestamp))
                        }
                    })

                    nodes.forEach(function (element) {
                        accuracyData.addColumn('number', element);
                        recallData.addColumn('number', element);
                        precisionData.addColumn('number', element);
                        f1Data.addColumn('number', element);
                    })

                    times.forEach(function (time) {
                        var accuracyRow = [time]
                        var precisionRow = [time]
                        var f1Row = [time]
                        var recallRow = [time]
                        nodes.forEach(function (node) {
                            var found = false
                            for (let i = 0; i < response.length; i++) {
                                var element = response[i];
                                if ((new Date(element.timestamp).getTime() == time.getTime()) && element.address == node) {
                                    precisionRow.push(element.precision)
                                    f1Row.push(element.f1)
                                    recallRow.push(element.recall)
                                    accuracyRow.push(element.accuracy)
                                    found = true
                                    break;
                                }
                            }
                            if (found === false) {
                                precisionRow.push(0)
                                accuracyRow.push(0)  //null
                                f1Row.push(0)
                                recallRow.push(0)
                            }

                        })
                        accuracyData.addRow(accuracyRow)
                        f1Data.addRow(f1Row)
                        recallData.addRow(recallRow)
                        precisionData.addRow(precisionRow)

                    })
                    accuracy_chart.draw(accuracyData, options);
                    precision_chart.draw(precisionData, options);
                    f1_chart.draw(f1Data, options);
                    recall_chart.draw(recallData, options);

                    $("#updated").text("Last update: " + new Date())

                },
                error: (error) => {
                    console.log(error);
                }

            })
        }
        function getAlerts() {
             $.ajax({
                 url: "http://127.0.0.1:8000/alert/",
                 type: "GET",
                 async: true,
                 dataType: "json",
                 success: (response) => {

                     var alerts = 0
                     var warnings = 0

                     for (let i = 0; i < response.length; i++) {        //type = danger, warning, info
                          if (response[i].active == true && response[i].category == "alert"){
                                    alerts = alerts+1
                               var element = document.getElementById("alert-card");
                                     element.classList.add("bg-danger");
                          }
                         if (response[i].active == true & response[i].category == "warning"){
                                 warnings = warnings+1
                                  var element = document.getElementById("warning-card");
                                     element.classList.add("bg-warning");
                         }
                     }
                     if(alerts == 0){
                            var element = document.getElementById("alert-card");
                                     element.classList.remove("bg-danger");
                     }
                      if(warnings == 0){
                            var element = document.getElementById("warning-card");
                                     element.classList.remove("bg-warning");
                     }

                    document.getElementById('alert_box').innerText   = alerts
                    document.getElementById('warning_box').innerText   = warnings
                 },
                 error: (error) => {
                     console.log(error);
                 }

             })
         }
         function getServerStates() {
             $.ajax({
                 url: "http://127.0.0.1:8000/aggregation/",
                 type: "GET",
                 async: true,
                 dataType: "json",
                 success: (response) => {
                     const givenDate = new Date(response[response.length-1].agg_time);
                     const timeDifferenceMs = new Date() - givenDate;
                     const diffMinutes = Math.floor(timeDifferenceMs / (1000 * 60));
                     if(diffMinutes< 1){
                         var element = document.getElementById("agg_box");
                         document.getElementById("agg_status").innerText = response[response.length-1].agg_status;
                         document.getElementById("agg_count").innerText = response[response.length-1].agg_count;
                         element.classList.add("bg-success");
                         element.classList.remove("bg-warning");
                     }
                     else{
                         var element = document.getElementById("agg_box");
                         document.getElementById("agg_status").innerText = "Offline";
                         document.getElementById("agg_count").innerText = "-";
                         element.classList.remove("bg-success");
                         element.classList.add("bg-warning");
                     }
                     document.getElementById("agg_time").innerText = (new Date(response[response.length-1].agg_time)).toLocaleString();
                     },
                 error: (error) => {
                     console.log(error);
                 }
             })
             $.ajax({
                 url: "http://127.0.0.1:8000/prediction/",
                 type: "GET",
                 async: true,

                 dataType: "json",
                 success: (response) => {
                     const givenDate = new Date(response[response.length-1].pred_time);
                     const timeDifferenceMs = new Date() - givenDate;
                     const diffMinutes = Math.floor(timeDifferenceMs / (1000 * 60));
                     if(diffMinutes< 1){
                         var element = document.getElementById("pred_box");
                         document.getElementById("pred_status").innerText = response[response.length-1].pred_status;
                         document.getElementById("pred_count").innerText = response[response.length-1].pred_count;
                         element.classList.add("bg-success");
                         element.classList.remove("bg-warning");
                     }
                     else{
                          var element = document.getElementById("pred_box");
                          document.getElementById("pred_status").innerText = "Offline";
                          document.getElementById("pred_count").innerText = "-";
                          element.classList.remove("bg-success");
                          element.classList.add("bg-warning");
                     }
                     document.getElementById("pred_time").innerText = (new Date(response[response.length-1].pred_time)).toLocaleString();
                     },
                 error: (error) => {
                     console.log(error);
                 }
             })
             $.ajax({
                 url: "http://127.0.0.1:8000/evaluation/",
                 type: "GET",
                 dataType: "json",
                 async: true,

                 success: (response) => {
                     const givenDate = new Date(response[response.length-1].eval_time);
                     const timeDifferenceMs = new Date() - givenDate;
                     const diffMinutes = Math.floor(timeDifferenceMs / (1000 * 60));
                     if(diffMinutes< 1){
                         var element = document.getElementById("eval_box");
                         document.getElementById("eval_status").innerText = response[response.length-1].eval_status;
                         document.getElementById("eval_count").innerText = response[response.length-1].eval_count;
                         element.classList.add("bg-success");
                         element.classList.remove("bg-warning");
                     }
                     else{
                          var element = document.getElementById("eval_box");
                          document.getElementById("eval_status").innerText = "Offline";
                          document.getElementById("eval_count").innerText = "-";
                          element.classList.remove("bg-success");
                          element.classList.add("bg-warning");
                     }
                     document.getElementById("eval_time").innerText = (new Date(response[response.length-1].eval_time)).toLocaleString();
                     },
                 error: (error) => {
                     console.log(error);
                 }
             })

         }


        sendRequest();
        setInterval(sendRequest, updateInterval*1000);

        getServerStates();
        setInterval(getServerStates, updateInterval*1000);

        getAlerts();
        setInterval(getAlerts, updateInterval* 1000);

    }


</script>


<br>
<br>
<div class={% if dark_theme %}"card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
    <div class="card-header">
        <i class="fa-solid fa-signal"></i>
        Operational Status
    </div>
    <div class="card-body">
        <div class="row">

            <div class="col-xl-3 col-md-3">
                <div id="agg_box" class="card bg-warning text-white mb-4" style="height:6cm;  display:flex">
                    <div class="card-header"><i class="fa-solid fa-server"></i> Model Aggregation:</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-8 col-md-6">
                                 <div id="agg_status"></div> <br>
                                Last connection: <div id="agg_time"></div>
                            </div>
                            <div class="col-xl-4 col-md-6">
                                Nodes:
                                <p style="font-size:40px;" id="agg_count"></p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href={% url "aggregate" %} >View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-3">
                <div id="pred_box" class="card bg-warning text-white mb-4" style="height:6cm;  display:flex">
                    <div class="card-header"><i class="fa-solid fa-server"></i> Prediction Aggregation:</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-8 col-md-6">
                                <div id="pred_status"></div><br>
                                Last connection:<div id="pred_time"></div>
                            </div>
                            <div class="col-xl-4 col-md-6">
                                Nodes:
                                <p style="font-size:40px;" id="pred_count"></p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href={% url "evaluate" %} >View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-3">
                <div id="eval_box" class="card bg-warning text-white mb-4" style="height:6cm;  display:flex">
                    <div class="card-header"><i class="fa-solid fa-chart-line"></i> Evaluation Aggregation:</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-8 col-md-6">
                                <div id="eval_status"></div><br>
                                Last connection:<div id="eval_time"></div>
                            </div>
                            <div class="col-xl-4 col-md-6">
                                Nodes:
                                <p style="font-size:40px;" id="eval_count"></p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href={% url "evaluate" %} >View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>


            <div class="col-xl-3 col-md-3">
                <div id="warning-card" class="card bg-secondary text-white mb-4" style="height:2.7cm;  display:flex">
                    <div class="card-header"><i class="fa-solid fa-triangle-exclamation"></i> Warnings:</div>
                    <div class="card-body">
                        <div id ="warning_box" style="font-size:30px; margin-top: -0.3cm"></div>
                    </div>
                    <a class="small text-white stretched-link" href={% url "alerts" %} ></a>

                </div>

                <div  id="alert-card" class="card bg-secondary text-white mb-4" style="height:2.7cm; display:flex">
                    <div class="card-header"><i class="fa-solid fa-skull-crossbones"></i> Alerts:
                    </div>
                    <div class="card-body">
                        <p id ="alert_box"  style="font-size:30px; margin-top: -0.3cm"></p>
                    </div>
                                        <a class="small text-white stretched-link" href={% url "alerts" %} ></a>

                </div>
            </div>

        </div>

    </div>
    <div id="updated" class="card-footer small text-muted"></div>

</div>


<div class="row">
    <div class="col-xl-6 col-md-6">
        <div class={% if dark_theme %}
            "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %} >
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                F1-Score
            </div>
            <div id="f1_chart" class="card-body"></div>
            <div id="updated4" class="card-footer small text-muted">
                <a class="small text-secondary stretched-link" href={% url "f1-score" %} >View Details</a>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6">
        <div class={% if dark_theme %}
            "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                Precision
            </div>
            <div id="precision_chart" class="card-body"></div>
            <div id="updated1" class="card-footer small text-muted">
                <a class="small text-secondary stretched-link" href={% url "precision" %} >View Details</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-6 col-md-6">
        <div class={% if dark_theme %}
        "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                Recall
            </div>
            <div id="recall_chart" class="card-body"></div>
            <div id="updated2" class="card-footer small text-muted">
                <a class="small text-secondary stretched-link" href={% url "recall" %} >View Details</a>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6">
        <div class={% if dark_theme %}
        "card bg-dark text-white mb-4" {% else %} "card mb-4" {% endif %}>
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                Accuracy
            </div>
            <div id="accuracy_chart" class="card-body">
            </div>
            <div id="updated3" class="card-footer small text-muted">
                <a class="small text-secondary stretched-link" href={% url "accuracy" %} >View Details</a>
            </div>
        </div>
    </div>

</div>


{% endblock %}
